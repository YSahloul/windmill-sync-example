summary: 'Ban a user, notify them by email, and us by Slack'
description: >-
  Note: This flow connects to a Postgresql resource and updates the `user`
  table. It requires the following columns: `username`, `email`, `banned`,
  `ban_reason`.


  Set banned flag, notify user via email, send slack message about the
  operation.
value:
  modules:
    - summary: Flag user in users table
      value:
        content: '!inline flag_user_in_users_table.inline_script.ts'
        input_transforms:
          db:
            expr: flow_input.db
            type: javascript
          reason:
            expr: '`${flow_input.reason}`'
            type: javascript
          username:
            expr: '`${flow_input.username}`'
            type: javascript
        language: deno
        lock: ''
        type: rawscript
      id: a
      input_transforms: {}
    - summary: Retrieve email address from username
      value:
        content: '!inline retrieve_email_address_from_username.inline_script.ts'
        input_transforms:
          db:
            expr: flow_input.db
            type: javascript
          username:
            expr: '`${flow_input.username}`'
            type: javascript
        language: deno
        lock: ''
        type: rawscript
      id: b
      input_transforms: {}
    - summary: Notify user about ban via email
      value:
        input_transforms:
          gmail_auth:
            expr: flow_input.gmail
            type: javascript
          message:
            expr: >-
              `Hello ${flow_input.username},

              We regret to inform you, you have been banned for the following
              reason: 

              ${flow_input.reason}

              Best regards`
            type: javascript
          subject:
            value: You have been banned
            type: static
          to_email:
            expr: '`${step(1)[0][0]}`'
            type: javascript
          userId:
            value: me
            type: static
        path: hub/209/gmail/_send_email
        type: script
      id: c
      input_transforms: {}
    - summary: Send a message to Slack reporting the ban
      value:
        input_transforms:
          channel:
            expr: '`${flow_input.slack_channel}`'
            type: javascript
          slack:
            expr: flow_input.slack
            type: javascript
          text:
            expr: >-
              `User ${flow_input.username} was banned. Reason:
              ${flow_input.reason}`
            type: javascript
        path: hub/111/slack/send_message_to_channel
        type: script
      id: d
      input_transforms: {}
schema:
  $schema: 'https://json-schema.org/draft/2020-12/schema'
  properties:
    db:
      description: Database containing the users table
      default: '$res:g/all/demodb'
      format: resource-postgresql
      type: object
    gmail:
      description: GMail account used to send the notification email
      format: resource-gmail
      type: object
    reason:
      description: Brief description for the reason of the ban
      default: aggressive towards windmills
      format: ''
      type: string
    slack:
      description: Slack Account used to send notification message
      format: resource-slack
      type: object
    slack_channel:
      description: Channel name to send the notification to
      default: bans
      format: ''
      type: string
    username:
      description: Username in the database
      default: don
      format: ''
      type: string
  required:
    - username
    - slack_channel
    - db
    - gmail
    - username
    - db
    - gmail
    - db
    - gmail
    - gmail
    - db
    - slack
  type: object
